


ARM Macro Assembler    Page 1 


    1 00000000         ; Declare a code data AREA, which allows the linker 
    2 00000000         ; to allocate the code segment memory space 
    3 00000000         ; Name it Printer 
    4 00000000         
    5 00000000                 AREA             Printer, CODE, READONLY
    6 00000000         
    7 00000000         ; Import some routines from a library to allow printing 
                       
    8 00000000                 IMPORT           PrintHex
    9 00000000                 IMPORT           PrintString
   10 00000000                 IMPORT           PrintChar
   11 00000000                 IMPORT           PrintHello
   12 00000000                 IMPORT           fputc
   13 00000000         
   14 00000000                 IMPORT           SystemInit  ; link to C code 
   15 00000000                 EXPORT           Reset_Handler ; export the rese
                                                            t handler’s address
                                                             to C 
   16 00000000                 EXPORT           SVC_Handler
   17 00000000                 THUMB
   18 00000000                 PRESERVE8
   19 00000000         ENTRY                                ; indicate to the l
                                                            inker where to star
                                                            t the code 
   20 00000000         
   21 00000000         Reset_Handler                        ; also indicate whe
                                                            re to start 
   22 00000000 F7FF FFFE       BL               SystemInit  ; Invoke C code to 
                                                            configure the SoC c
                                                            orrectly 
   23 00000004         
   24 00000004         Start                                ; user code label f
                                                            or the start (optio
                                                            nal) 
   25 00000004         ;main
   26 00000004         
   27 00000004         ;initialise process stack 
   28 00000004 4982            LDR              r1, =0x20010000
   29 00000006 F381 8809       MSR              PSP, r1
   30 0000000A         
   31 0000000A         ;initialise baseId
   32 0000000A F04F 0000       MOV              r0, #0
   33 0000000E B401            push{r0}                     ;push main id
   34 00000010 B402            push{r1}                     ;push last main sta
                                                            ck position
   35 00000012 B401            push{r0}                     ;push lastid
   36 00000014         
   37 00000014 487F            LDR              r0, =osrunning
   38 00000016 F7FF FFFE       BL               PrintString ;we're still in han
                                                            dler mode, so we're
                                                             allowed to directl
                                                            y access print
   39 0000001A         
   40 0000001A         ; And re-print it on the terminal 
   41 0000001A F000 F877       BL               Mode_Switch
   42 0000001E         
   43 0000001E 497E            LDR              r1, =ProcessTable ; initialise 
                                                            counter 
   44 00000020         ;LDR r2, =ProcessTable 



ARM Macro Assembler    Page 2 


   45 00000020 4B7E            LDR              r3, =ProcessTableEnd
   46 00000022         
   47 00000022         MainLoopStart
   48 00000022         
   49 00000022         ;LDR r0, [r2, r1, LSL #2]
   50 00000022 4299            CMP              r1, r3      ; compare the chose
                                                            n address with the 
                                                            final address of th
                                                            e table
   51 00000024         ;BLGT Err_ProcessOutOfRange; if we're at an invalid proc
                       ess id, error out
   52 00000024 DA04            BGE              MainLoopEnd ; if we're at the e
                                                            nd of the table, fi
                                                            nish 
   53 00000026 6808            LDR              r0, [r1]
   54 00000028 DF05            SVC              5
   55 0000002A F101 0104       ADD              r1, r1, #4  ; increment counter
                                                            
   56 0000002E E7F8            B                MainLoopStart
   57 00000030         MainLoopEnd
   58 00000030         
   59 00000030 487B            LDR              r0, =osfinishing
   60 00000032 DF04            SVC              4
   61 00000034         
   62 00000034 E088            B                Stop
   63 00000036         
   64 00000036         SVC_Handler
   65 00000036         ;MOV r0, #0xbeef
   66 00000036 B500            PUSH{lr}
   67 00000038         ;BL PrintHex
   68 00000038 4603            MOV              r3, r0
   69 0000003A         ;get SVC operand
   70 0000003A F01E 0F04       TST              lr, #4
   71 0000003E BF0C            ITE              eq          ; check which mode 
                                                            we came from
   72 00000040 F3EF 8008       MRSEQ            r0, MSP     ; load the relevant
                                                             stack pointer
   73 00000044 F3EF 8009       MRSNE            r0, PSP
   74 00000048 6981            LDR              r1, [r0, #24] ; stacked PC
   75 0000004A F811 1C02       LDRB             r1, [r1, #-2] ; get SVC instruc
                                                            tion’s operand
   76 0000004E         
   77 0000004E 4A75            LDR              r2, =SVCTable
   78 00000050 F852 0021       LDR              r0, [r2, r1, LSL #2]
   79 00000054 4974            LDR              r1, =SVCTableEnd
   80 00000056 4288            CMP              r0, r1      ; compare the chose
                                                            n address with the 
                                                            final address of th
                                                            e table
   81 00000058         ;PUSH{r0}
   82 00000058 BFC8 F000 
              F871             BLGT             Err_SVCOutOfRange
   83 0000005E 4601            MOV              r1, r0
   84 00000060 4618            MOV              r0, r3
   85 00000062 4788            BLX              r1
   86 00000064         
   87 00000064 F85D EB04       POP{lr}
   88 00000068         ;MOV r2, #4
   89 00000068         ;POP{r0}



ARM Macro Assembler    Page 3 


   90 00000068         ;MOV r0, #42
   91 00000068         ;PUSH{r0}
   92 00000068 4770            BX               lr
   93 0000006A         
   94 0000006A         SVC_Kill
   95 0000006A BC01            pop{r0}                      ;pop lr from SVC_Ha
                                                            ndler
   96 0000006C BC02            pop{r1}                      ;pop id counter
   97 0000006E BC0C            pop{r2,          r3}         ; pop data about cu
                                                            rrent process, to t
                                                            hrow away
   98 00000070 4602            mov              r2, r0
   99 00000072 BC01            pop{r0}                      ; get current proce
                                                            ss stack pointer
  100 00000074 B402            push{r1}                     ; return id counter
                                                             to stack
  101 00000076 B404            push{r2}                     ;return lr
  102 00000078         ;we are now done with the main stack 
  103 00000078         
  104 00000078         ;resume last process here
  105 00000078         
  106 00000078 E8B0 0FF0       LDMFD            r0!, {r11, r10, r9, r8, r7, r6,
 r5, r4} 
                                                            ;restore other regi
                                                            sters
  107 0000007C         
  108 0000007C F380 8809       MSR              PSP, r0     ; update PSP. there
                                                             is no longer any w
                                                            ay of recovering th
                                                            e old process direc
                                                            tly 
  109 00000080         
  110 00000080         ;normal recovery should now be in play
  111 00000080         
  112 00000080 4770            BX               lr
  113 00000082         
  114 00000082         ;create the process addressed by r0
  115 00000082         SVC_Create
  116 00000082         ;get lr saved by previous
  117 00000082 BC08            pop{r3}
  118 00000084         ;get the id
  119 00000084 BC02            pop{r1}
  120 00000086 F101 0101       ADD              r1, #1      ;r1 now contains my
                                                             id 
  121 0000008A         
  122 0000008A         ;work on the process stack
  123 0000008A F3EF 8209       MRS              r2, PSP
  124 0000008E         ;MOV r4, #0x5464
  125 0000008E E922 0FF0       STMFD            r2!, {r11, r10, r9, r8, r7, r6,
 r5, r4} 
                                                            ;push all remaining
                                                             registers to stack
                                                            
  126 00000092         
  127 00000092         ;r5 is saved, so we can reuse it
  128 00000092 461D            MOV              r5, r3
  129 00000094         
  130 00000094 F85D 9B04       pop{r9}                      ; dispose of the pr
                                                            evious stackpointer



ARM Macro Assembler    Page 4 


                                                             for the *current* 
                                                            process
  131 00000098         ;put the final sp in r2 
  132 00000098 B404            push{r2}                     ;update it 
  133 0000009A         
  134 0000009A 4B5D            LDR              r3, =0x20010000
  135 0000009C         
  136 0000009C F44F 74FA       MOV              r4, #500
  137 000000A0 FB04 F401       MUL              r4, r4, r1
  138 000000A4         
  139 000000A4 EB03 0204       ADD              r2, r3, r4
  140 000000A8         
  141 000000A8 B406            push{r1,         r2}         ;add my id and init
                                                            ial sp (this value 
                                                            doesnt matter while
                                                             I'm running) to MS
                                                            P`
  142 000000AA B402            push{r1}                     ;update the last id
                                                             value
  143 000000AC B420            push{r5}
  144 000000AE         ;we are now done with updating the main stack
  145 000000AE         
  146 000000AE         ;work on the process stack
  147 000000AE         
  148 000000AE         ;at this point, 
  149 000000AE         ;0xFFFFFFFF default LR
  150 000000AE         ;0x01000000 default xPSR
  151 000000AE F04F 7680       MOV              r6, #0x01000000 ; put default x
                                                            PSR value in r0 
  152 000000B2 4605            MOV              r5, r0      ;put new pc in r5
  153 000000B4 F04F 34FF       MOV              r4, #0xFFFFFFFF ; put default L
                                                            R value in r0
  154 000000B8 4617            MOV              r7, r2
  155 000000BA         ;reset remaining main registers
  156 000000BA F04F 0001       MOV              r0, #1
  157 000000BE F04F 0102       MOV              r1, #2
  158 000000C2 F04F 0203       MOV              r2, #3
  159 000000C6 F04F 0300       MOV              r3, #0
  160 000000CA         
  161 000000CA         
  162 000000CA E927 0070       STMFD            r7!, {r6, r5, r4}
  163 000000CE         ; STMFD r7!, {r12, r6, r5, r4}
  164 000000CE E927 100F       STMFD            r7!, {r12, r3, r2, r1, r0}
  165 000000D2         ; STMFD r7!, {r0, r1, r2}
  166 000000D2 F387 8809       MSR              PSP, r7     ;update the stack p
                                                            ointer
  167 000000D6         
  168 000000D6         ;reset all registers that won't be overwritten
  169 000000D6 F04F 0400       MOV              r4, #0
  170 000000DA F04F 0500       MOV              r5, #0
  171 000000DE F04F 0600       MOV              r6, #0
  172 000000E2 F04F 0700       MOV              r7, #0
  173 000000E6 F04F 0800       MOV              r8, #0
  174 000000EA F04F 0900       MOV              r9, #0
  175 000000EE F04F 0A00       MOV              r10, #0
  176 000000F2 F04F 0B00       MOV              r11, #0
  177 000000F6         
  178 000000F6         ;return to our newly created process, via the SVC_Handle
                       r



ARM Macro Assembler    Page 5 


  179 000000F6 4770            BX               lr
  180 000000F8         
  181 000000F8         Switch                               ;put the address of
                                                             the corresponding 
                                                            process into r0
  182 000000F8         ;POP{r0}
  183 000000F8 4601            MOV              r1, r0      ;move the id, so we
                                                             can overwrite r0
  184 000000FA 4A47            LDR              r2, =ProcessTable
  185 000000FC F852 0021       LDR              r0, [r2, r1, LSL #2]
  186 00000100 4946            LDR              r1, =ProcessTableEnd
  187 00000102 4288            CMP              r0, r1      ; compare the chose
                                                            n address with the 
                                                            final address of th
                                                            e table
  188 00000104         ;PUSH{r0}
  189 00000104 BFC8 F000 
              F817             BLGT             Err_ProcessOutOfRange
  190 0000010A 4770            BX               lr
  191 0000010C         
  192 0000010C         Mode_Switch
  193 0000010C F04F 0002       MOV              r0, #0x2    ; set stack to PSP 
                                                            
  194 00000110 F380 8814       MSR              CONTROL, r0 ; do it 
  195 00000114 F3BF 8F6F       ISB                          ; wait for it to be
                                                             done 
  196 00000118         
  197 00000118 F04F 0003       MOV              r0, #0x03   ; set privilege lev
                                                            el to User. 
  198 0000011C         ; N.B. Cannot combine this to single MSR instruction wit
                       h 
  199 0000011C         ; above PSP change when using RVDS ISSM!! 
  200 0000011C F380 8814       MSR              CONTROL, r0
  201 00000120 F3BF 8F6F       ISB
  202 00000124 4770            BX               lr
  203 00000126         
  204 00000126         HelloWorld
  205 00000126 4841            LDR              r0, =helloworld
  206 00000128 DF04            SVC              4
  207 0000012A DF00            SVC              0
  208 0000012C         
  209 0000012C         HelloMars
  210 0000012C 4840            LDR              r0, =hellomars
  211 0000012E DF04            SVC              4
  212 00000130 DF00            SVC              0
  213 00000132         
  214 00000132         HelloGalaxy
  215 00000132 4840            LDR              r0, =hellogalaxy
  216 00000134 DF04            SVC              4
  217 00000136 DF00            SVC              0
  218 00000138         
  219 00000138         Err_ProcessOutOfRange
  220 00000138 483F            LDR              r0, =procoutofrangerr
  221 0000013A DF04            SVC              4
  222 0000013C F000 F804       BL               Stop
  223 00000140         
  224 00000140         Err_SVCOutOfRange
  225 00000140 483E            LDR              r0, =svcoutofrangerr
  226 00000142 DF04            SVC              4



ARM Macro Assembler    Page 6 


  227 00000144 F000 F800       BL               Stop
  228 00000148         
  229 00000148         ; ================ 
  230 00000148         ; End your program 
  231 00000148         ; ================ 
  232 00000148         Stop
  233 00000148 E7FE            B                Stop
  234 0000014A         
  235 0000014A         ; Declare some strings to be printed out 
  236 0000014A         ; These are constants and represent the data area 
  237 0000014A 00 00           ALIGN
  238 0000014C         ProcessTable
  239 0000014C 00000000        DCD              HelloWorld
  240 00000150 00000000        DCD              HelloMars
  241 00000154 00000000        DCD              HelloGalaxy
  242 00000158         ProcessTableEnd
  243 00000158         
  244 00000158         SVCTable
  245 00000158 00000000        DCD              SVC_Kill
  246 0000015C 00000000        DCD              PrintHex
  247 00000160 00000000        DCD              HelloMars   ; FIXME, should be 
                                                            print decimal
  248 00000164 00000000        DCD              PrintChar
  249 00000168 00000000        DCD              PrintString
  250 0000016C 00000000        DCD              SVC_Create
  251 00000170         SVCTableEnd
  252 00000170         
  253 00000170         youlike
  254 00000170 59 6F 75 
              20 6C 69 
              6B 65 3A 
              20 00            DCB              "You like: ",0
  255 0000017B         
  256 0000017B         osrunning
  257 0000017B 4F 53 20 
              72 75 6E 
              6E 69 6E 
              67 00            DCB              "OS running",0
  258 00000186         
  259 00000186         osfinishing
  260 00000186 47 6F 6F 
              64 62 79 
              65 21 00         DCB              "Goodbye!",0
  261 0000018F         
  262 0000018F         helloworld
  263 0000018F 48 65 6C 
              6C 6F 2C 
              20 77 6F 
              72 6C 64 
              21 00            DCB              "Hello, world!",0
  264 0000019D         
  265 0000019D         hellomars
  266 0000019D 48 65 6C 
              6C 6F 2C 
              20 6D 61 
              72 73 21 
              00               DCB              "Hello, mars!",0
  267 000001AA         
  268 000001AA         hellogalaxy



ARM Macro Assembler    Page 7 


  269 000001AA 48 65 6C 
              6C 6F 2C 
              20 67 61 
              6C 61 78 
              79 21 00         DCB              "Hello, galaxy!",0
  270 000001B9         
  271 000001B9         procoutofrangerr
  272 000001B9 45 72 72 
              6F 72 3A 
              20 72 65 
              71 75 65 
              73 74 65 
              64 20 70 
              72 6F 63 
              65 73 73 
              20 69 64 
              20 69 73 
              20 6F 75 
              74 20 6F 
              66 20 72 
              61 6E 67 
              65 00            DCB              "Error: requested process id is
 out of range",0
  273 000001E5         
  274 000001E5         svcoutofrangerr
  275 000001E5 45 72 72 
              6F 72 3A 
              20 72 65 
              71 75 65 
              73 74 65 
              64 20 53 
              56 43 20 
              69 64 20 
              69 73 20 
              6F 75 74 
              20 6F 66 
              20 72 61 
              6E 67 65 
              00               DCB              "Error: requested SVC id is out
 of range",0
  276 0000020D 00 00 00        ALIGN
  277 00000210         
  278 00000210         
  279 00000210                 END
              20010000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
Command Line: --debug --xref --cpu=Cortex-M4.fp --apcs=interwork --depend=.\bas



ARM Macro Assembler    Page 8 


e.d -o.\base.o -IC:\Keil\ARM\RV31\INC -IC:\Keil\ARM\CMSIS\Include -IC:\Keil\ARM
\Inc\ST\STM32F4xx --predefine="__EVAL SETA 1" --predefine="__MICROLIB SETA 1" -
-list=.\base.lst base.s



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
Relocatable symbols

ENTRY 00000000

Symbol: ENTRY
   Definitions
      At line 19 in file base.s
   Uses
      None
Comment: ENTRY unused
Err_ProcessOutOfRange 00000138

Symbol: Err_ProcessOutOfRange
   Definitions
      At line 219 in file base.s
   Uses
      At line 189 in file base.s
Comment: Err_ProcessOutOfRange used once
Err_SVCOutOfRange 00000140

Symbol: Err_SVCOutOfRange
   Definitions
      At line 224 in file base.s
   Uses
      At line 82 in file base.s
Comment: Err_SVCOutOfRange used once
HelloGalaxy 00000132

Symbol: HelloGalaxy
   Definitions
      At line 214 in file base.s
   Uses
      At line 241 in file base.s
Comment: HelloGalaxy used once
HelloMars 0000012C

Symbol: HelloMars
   Definitions
      At line 209 in file base.s
   Uses
      At line 240 in file base.s
      At line 247 in file base.s

HelloWorld 00000126

Symbol: HelloWorld
   Definitions
      At line 204 in file base.s
   Uses
      At line 239 in file base.s
Comment: HelloWorld used once
MainLoopEnd 00000030

Symbol: MainLoopEnd
   Definitions
      At line 57 in file base.s
   Uses
      At line 52 in file base.s
Comment: MainLoopEnd used once
MainLoopStart 00000022




ARM Macro Assembler    Page 2 Alphabetic symbol ordering
Relocatable symbols

Symbol: MainLoopStart
   Definitions
      At line 47 in file base.s
   Uses
      At line 56 in file base.s
Comment: MainLoopStart used once
Mode_Switch 0000010C

Symbol: Mode_Switch
   Definitions
      At line 192 in file base.s
   Uses
      At line 41 in file base.s
Comment: Mode_Switch used once
Printer 00000000

Symbol: Printer
   Definitions
      At line 5 in file base.s
   Uses
      None
Comment: Printer unused
ProcessTable 0000014C

Symbol: ProcessTable
   Definitions
      At line 238 in file base.s
   Uses
      At line 43 in file base.s
      At line 184 in file base.s

ProcessTableEnd 00000158

Symbol: ProcessTableEnd
   Definitions
      At line 242 in file base.s
   Uses
      At line 45 in file base.s
      At line 186 in file base.s

Reset_Handler 00000000

Symbol: Reset_Handler
   Definitions
      At line 21 in file base.s
   Uses
      At line 15 in file base.s
Comment: Reset_Handler used once
SVCTable 00000158

Symbol: SVCTable
   Definitions
      At line 244 in file base.s
   Uses
      At line 77 in file base.s
Comment: SVCTable used once
SVCTableEnd 00000170

Symbol: SVCTableEnd



ARM Macro Assembler    Page 3 Alphabetic symbol ordering
Relocatable symbols

   Definitions
      At line 251 in file base.s
   Uses
      At line 79 in file base.s
Comment: SVCTableEnd used once
SVC_Create 00000082

Symbol: SVC_Create
   Definitions
      At line 115 in file base.s
   Uses
      At line 250 in file base.s
Comment: SVC_Create used once
SVC_Handler 00000036

Symbol: SVC_Handler
   Definitions
      At line 64 in file base.s
   Uses
      At line 16 in file base.s
Comment: SVC_Handler used once
SVC_Kill 0000006A

Symbol: SVC_Kill
   Definitions
      At line 94 in file base.s
   Uses
      At line 245 in file base.s
Comment: SVC_Kill used once
Start 00000004

Symbol: Start
   Definitions
      At line 24 in file base.s
   Uses
      None
Comment: Start unused
Stop 00000148

Symbol: Stop
   Definitions
      At line 232 in file base.s
   Uses
      At line 62 in file base.s
      At line 222 in file base.s
      At line 227 in file base.s
      At line 233 in file base.s

Switch 000000F8

Symbol: Switch
   Definitions
      At line 181 in file base.s
   Uses
      None
Comment: Switch unused
hellogalaxy 000001AA

Symbol: hellogalaxy



ARM Macro Assembler    Page 4 Alphabetic symbol ordering
Relocatable symbols

   Definitions
      At line 268 in file base.s
   Uses
      At line 215 in file base.s
Comment: hellogalaxy used once
hellomars 0000019D

Symbol: hellomars
   Definitions
      At line 265 in file base.s
   Uses
      At line 210 in file base.s
Comment: hellomars used once
helloworld 0000018F

Symbol: helloworld
   Definitions
      At line 262 in file base.s
   Uses
      At line 205 in file base.s
Comment: helloworld used once
osfinishing 00000186

Symbol: osfinishing
   Definitions
      At line 259 in file base.s
   Uses
      At line 59 in file base.s
Comment: osfinishing used once
osrunning 0000017B

Symbol: osrunning
   Definitions
      At line 256 in file base.s
   Uses
      At line 37 in file base.s
Comment: osrunning used once
procoutofrangerr 000001B9

Symbol: procoutofrangerr
   Definitions
      At line 271 in file base.s
   Uses
      At line 220 in file base.s
Comment: procoutofrangerr used once
svcoutofrangerr 000001E5

Symbol: svcoutofrangerr
   Definitions
      At line 274 in file base.s
   Uses
      At line 225 in file base.s
Comment: svcoutofrangerr used once
youlike 00000170

Symbol: youlike
   Definitions
      At line 253 in file base.s
   Uses



ARM Macro Assembler    Page 5 Alphabetic symbol ordering
Relocatable symbols

      None
Comment: youlike unused
29 symbols



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
External symbols

PrintChar 00000000

Symbol: PrintChar
   Definitions
      At line 10 in file base.s
   Uses
      At line 248 in file base.s
Comment: PrintChar used once
PrintHello 00000000

Symbol: PrintHello
   Definitions
      At line 11 in file base.s
   Uses
      None
Comment: PrintHello unused
PrintHex 00000000

Symbol: PrintHex
   Definitions
      At line 8 in file base.s
   Uses
      At line 246 in file base.s
Comment: PrintHex used once
PrintString 00000000

Symbol: PrintString
   Definitions
      At line 9 in file base.s
   Uses
      At line 38 in file base.s
      At line 249 in file base.s

SystemInit 00000000

Symbol: SystemInit
   Definitions
      At line 14 in file base.s
   Uses
      At line 22 in file base.s
Comment: SystemInit used once
fputc 00000000

Symbol: fputc
   Definitions
      At line 12 in file base.s
   Uses
      None
Comment: fputc unused
6 symbols
370 symbols in table
